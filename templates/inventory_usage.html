{% extends "base.html" %}

{% block title %}Inventory Usage - Speantag Bakery{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-box-open me-2"></i>Record Inventory Usage
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="mb-3">
                        <label for="inventory_item_id" class="form-label">Select Item</label>
                        <select class="form-control" id="inventory_item_id" name="inventory_item_id" required>
                            <option value="">Choose an item...</option>
                            {% for item in inventory_items %}
                            <option value="{{ item.id }}" data-cost="{{ item.cost_per_unit }}" data-remaining="{{ item.remaining_quantity }}">
                                {{ item.item_name }} ({{ item.remaining_quantity }} remaining)
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="quantity_used" class="form-label">Quantity Used</label>
                        <input type="number" class="form-control" id="quantity_used" name="quantity_used" step="0.01" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="usage_date" class="form-label">Usage Date</label>
                        <input type="date" class="form-control" id="usage_date" name="usage_date" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Cost Used</label>
                        <div class="form-control bg-light" id="cost_used_display">₵0.00</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Expected Profit</label>
                        <div class="form-control bg-light" id="expected_profit_display">₵0.00</div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-save me-2"></i>Record Usage
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-boxes me-2"></i>Current Inventory
                    </div>
                    <div class="card-body">
                        {% if inventory_items %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Remaining</th>
                                        <th>Cost/Unit</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in inventory_items %}
                                    <tr>
                                        <td>{{ item.item_name }}</td>
                                        <td>{{ item.remaining_quantity }}</td>
                                        <td>₵{{ "%.2f"|format(item.cost_per_unit) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No inventory items available.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-history me-2"></i>Recent Usage
                    </div>
                    <div class="card-body">
                        {% if usage_records %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Item</th>
                                        <th>Qty Used</th>
                                        <th>Cost</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for usage in usage_records %}
                                    <tr>
                                        <td>{{ usage.usage_date.strftime('%Y-%m-%d') }}</td>
                                        <td>
                                            {% for item in inventory_items %}
                                                {% if item.id == usage.inventory_item_id %}
                                                    {{ item.item_name }}
                                                {% endif %}
                                            {% endfor %}
                                        </td>
                                        <td>{{ usage.quantity_used }}</td>
                                        <td>₵{{ "%.2f"|format(usage.cost_used) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No usage records yet.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Set today's date as default
    $('#usage_date').val(new Date().toISOString().split('T')[0]);
    
    // Calculate cost and profit when item or quantity changes
    function calculateCosts() {
        const selectedOption = $('#inventory_item_id option:selected');
        const costPerUnit = parseFloat(selectedOption.data('cost')) || 0;
        const quantityUsed = parseFloat($('#quantity_used').val()) || 0;
        const remainingQuantity = parseFloat(selectedOption.data('remaining')) || 0;
        
        const costUsed = quantityUsed * costPerUnit;
        const expectedProfit = costUsed * 0.3; // 30% profit margin
        
        $('#cost_used_display').text('₵' + costUsed.toFixed(2));
        $('#expected_profit_display').text('₵' + expectedProfit.toFixed(2));
        
        // Validate quantity
        if (quantityUsed > remainingQuantity) {
            $('#quantity_used').addClass('is-invalid');
            $('.btn-primary').prop('disabled', true);
        } else {
            $('#quantity_used').removeClass('is-invalid');
            $('.btn-primary').prop('disabled', false);
        }
    }
    
    $('#inventory_item_id, #quantity_used').on('change input', calculateCosts);
    
    // Initial calculation
    calculateCosts();
});
</script>
{% endblock %} 